!function(d){"use strict";function o(t,e){this.$elem=d(t),this.options=d.extend({},o.defaultOptions,e),this.models={};var n=this;this.$elem.on("click",".pb-widget-toggle-control, .pb-widget-title",function(t){d(this).closest(".pb-widget").toggleClass("closed")}),this.$elem.on("click",".pb-widget-add-control",function(t){var e=d(this).closest(".pb-widget");n.widgetPicker(e,function(t){alert("!"),e.find("> .pb-widget-inside > .pb-widget-container").append(t)})}),this.$elem.on("click",".pb-widget-edit-control",function(t){d(this).closest(".pb-widget")}),this.$elem.on("click",".pb-widget-copy-control",function(t){var e=d(this).closest(".pb-widget");n.duplicateWidget(e).insertAfter(e)}),this.$elem.on("click",".pb-widget-delete-control",function(t){var e=d(this).closest(".pb-widget");window.confirm(n.options.confirmDelete)&&n.removeWidget(e)}),this.$elem.on("click",".pb-add-widget-control",function(t){n.widgetPicker(null,function(t){n.$elem.find(".pb-widgets").append(t)})}),this.$elem.on("pb/load",function(t,e){d.each(e.models,function(t,e){var i=n.createWidget(e),o=n.$elem.find(".pb-widgets");e.parent&&(o=n.$elem.find(".pb-widgets .pb-widget").filter(function(){return d(this).data("model")==e.parent}).find("> .pb-widget-inside > .pb-widget-container")),o.append(i)})}),this.$elem.find(".pb-widgets").sortable({placeholder:"pb-widget-placeholder",items:"> .pb-widget",handle:"> .pb-widget-top > .pb-widget-title",cursor:"move",distance:2,containment:"#wpwrap",tolerance:"pointer",refreshPositions:!0}),d(document).trigger("pb/init",[this]),this.load()}o.defaultOptions={post:null,nonceName:null,nonce:null,widgetDefaults:{},confirmDelete:"Are you sure you want to delete this widget?",ajaxurl:window.ajaxurl||null},o.generateId=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},o.prototype.prepareAjax=function(t){return t=d.extend({},t),this.options.nonceName&&(t[this.options.nonceName]=this.options.nonce),t},o.prototype.createModel=function(t){var e={};"object"==typeof t&&void 0!==t.type&&void 0!==this.options.widgetDefaults[t.type]&&(e=d.extend({},this.options.widgetDefaults[t.type]));var i={id:o.generateId(),type:null,data:e};return t=d.extend({},i,t)},o.prototype.createWidget=function(t){t=this.createModel(t);this.models[t.id]=t;var e=this.$elem.find(".pb-available-widgets .pb-widget").filter(function(){return d(this).data("type")==t.type});return e.data("model",t.id),e},o.prototype.removeWidget=function(t){var e=d(t),i=this;return e.find(".pb-widget").addBack().each(function(){var t=d(this).data("model");delete i.models[t],d.removeData(this,"model")}),e.remove()},o.prototype.duplicateWidget=function(t){var e=d(t).clone(!0),i=this;return e.find(".pb-widget").addBack().each(function(){var t=d(this).data("model"),e=d.extend({},i.models[t]);delete e.id,e=i.createModel(e),i.models[e.id]=e,d(this).data("model",e.id)}),e},o.prototype.widgetPicker=function(t,o){var n=this;d.ajax({url:this.options.ajaxurl,data:this.prepareAjax({action:"pb_widget_picker"}),method:"post",context:this,success:function(t){d.featherlight(t,{namespace:"pb-modal",closeIcon:"",afterContent:function(){this.$content.closest(".pb-modal").attr("id","pb-widget-picker-modal");var i=this;this.$content.on("click",".pb-widget-button",function(t){var e=n.createWidget({type:d(this).data("type")});o(e),i.close()})}})}})},o.prototype.load=function(){this.models={},this.$elem.find(".pb-widgets").empty(),d.ajax({url:this.options.ajaxurl,data:this.prepareAjax({action:"pb_load",post:this.options.post}),method:"post",context:this,success:function(t){this.$elem.trigger("pb/load",[t])}})},d.fn.pageBuilder=function(e){return this.each(function(){if(void 0===d(this).data("pageBuilder")){var t=new o(this,e);d(this).data("pageBuilder",t)}})}}(jQuery);